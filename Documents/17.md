LangChain
保存済み
RAG 構築(2): Context 注入と LLM 生成
前のステップでは、RAG システムの「R」、つまり Retriever を使って質問に関連する情報 **Context** を見つけ出す方法をマスターしましたね！これで、AI が回答を考えるための重要な材料を手に入れることができました。

さあ、いよいよ RAG (Retrieval-Augmented Generation) の核心部分、**「Augment (拡張)」** と **「Generate (生成)」** に挑戦です！このステップでは、Retriever が見つけてきた Context と、ユーザーからの元の質問を上手く組み合わせて、AI (LLM) に「これを元に答えてね！」とお願いするプロンプトを作り、最終的な回答を生成させる方法を学びます。

そして、この一連の流れを、LangChain の魔法の杖 **LCEL (LangChain Expression Language)** を使って、エレガントな一本の処理 **チェーン** として繋ぎ合わせます！ RAG システムを完成させましょう！

## 1. はじめに：このステップで目指すこと

### 🎯 今回のゴール

このステップを最後まで進むと、あなたはこんなことができるようになります！

- Retriever が取得した **Context** とユーザーの質問を組み合わせて、LLM への指示（プロンプト）を作成する方法を理解します。
- **LCEL** を使い、情報検索 (Retrieve) から回答生成 (Generate) までの一連の流れを **チェーン** として構築できるようになります。
- **`RunnablePassthrough`** や **`RunnableLambda`** といった LCEL の便利な道具を使って、データフローを制御する方法を学びます。
- **具体的な成果物:** ステップ 16 で準備した Retriever と LLM を使い、取得した Context に基づいて質問に答える、基本的な **RAG チェーン** の Python コードを完成させ、実行結果を確認します。

### 🔑 このステップのポイント

今回の冒険で特に重要な考え方や技術です。

- **RAG チェーン:** Retrieve → Augment → Generate の流れを LCEL で繋いだもの。
- **Context 注入:** 取得した文書リスト (Context) をプロンプトに埋め込むこと。
- **プロンプトエンジニアリング for RAG:** Context を活用し、事実に基づいた回答を促すプロンプトの工夫。
- **LCEL パイプ (`|`):** コンポーネントを繋ぐ基本。
- **`RunnablePassthrough`:** データを次のステップにそのまま渡したり、複数の入力を扱ったりするのに役立つ部品。
- **Context のフォーマット:** **Document** オブジェクトのリストを、プロンプトに入れやすい文字列形式に変換する必要性。
- **`RunnableLambda`:** Python 関数を LCEL チェーンに組み込むためのラッパー。

### ✅ 前提知識

このステップに挑戦する前に、以下の準備と知識を確認しましょう。

- **ステップ 16「RAG 構築(1): Retriever と Context 取得」の内容:** **FAISS** Vector Store から **Retriever** を作成し、`.invoke()` で関連 **Document** リストを取得できること。（FAISS を使う前提で進めます！）
- **ステップ 5 & 6「LCEL 入門」の内容:** **LCEL** の基本的な考え方、パイプ **`|`** 演算子、**`.invoke()`** でのチェーン実行を知っていること。
- **ステップ 3「AI への指示書！プロンプトを工夫しよう」の内容:** **`ChatPromptTemplate`** の使い方。
- **Python の基本:** 関数の定義 (`def`)、リスト内包表記、f-string など。
- **必要なライブラリ:** 特に `faiss-cpu` (または `faiss-gpu`), `langchain`, `langchain-community`, `langchain-openai` がインストールされていること。（`chromadb` は不要です）
- **API キー:** OpenAI API キーが設定されていること。

準備が整ったら、RAG チェーン構築の旅へ出発です！

---

## 2. 準備運動：Context をどう使う？

### 🎯 目標

Retriever が見つけてきた情報 (Context) を、どうやって LLM への指示 (プロンプト) に組み込むのか、その基本的な考え方と、LCEL でそれを実現するための部品を理解しましょう。

### なぜ Context をプロンプトに入れるの？

LLM は非常に賢いですが、私たちが Vector Store に入れた特定の情報や最新の情報は知りません。そこで、Retriever が見つけてきた関連情報 (**Context**) を、「参考資料」として LLM に渡してあげるのです。

プロンプトの中で、
「**この Context を参考にして、以下の質問に答えてください。**」
のように指示することで、LLM はその Context に書かれている内容に基づいて、より正確で信頼性の高い回答を生成しようとします。これが RAG の基本的な仕組みです。

### Context リストを文字列に変換！ (と `RunnableLambda`)

Retriever が返す Context は、通常、**`Document`** オブジェクトの **リスト** です。しかし、プロンプトテンプレートに埋め込むためには、多くの場合、これを一つの **文字列** に変換する必要があります。
コンテンツがありません

コミュニティガイドラインに則った投稿をしましょう。

編集中…無題のチャプター | Zenn
